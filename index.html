<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BlockSense — Secure Demo</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{--bg:#050710;--panel:rgba(255,255,255,0.03);--muted:#9fb3c9;--neon1:#00f0e0;--neon2:#8b63ff}
*{box-sizing:border-box}html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#e8fbff}
.container{max-width:1180px;margin:28px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center}
.brand{display:flex;gap:14px;align-items:center}
.logoBox{width:72px;height:72px;border-radius:12px;background:linear-gradient(135deg,var(--neon2),var(--neon1));display:flex;align-items:center;justify-content:center;box-shadow:0 18px 60px rgba(0,240,224,0.06)}
.title{font-weight:900}
.subtitle{color:var(--muted);font-size:13px}
.controls{display:flex;gap:10px;align-items:center}
.btn{padding:10px 14px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
.btn-primary{background:linear-gradient(90deg,var(--neon2),var(--neon1));color:#041226}
.grid{display:grid;grid-template-columns:420px 1fr;gap:20px;margin-top:18px}
.panel{background:var(--panel);padding:14px;border-radius:12px}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.input{padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e8fbff}
.qr-wrap{width:180px;height:180px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center}
.muted{color:var(--muted)}
.toast{position:fixed;right:18px;bottom:18px;padding:10px 12px;border-radius:8px;background:linear-gradient(90deg,#061226,#08132a);color:#dff8ff}
#issuedBox pre{white-space:pre-wrap;color:#dff8ff}
.verify-card{display:flex;gap:12px;align-items:center}
@media(max-width:980px){.grid{grid-template-columns:1fr}.logoBox{display:none}}
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="brand">
      <div class="logoBox" id="logoBox">
        <img src="blocksense-logo.png" alt="BlockSense" style="width:64px;height:64px;border-radius:8px" onerror="this.style.display='none';document.getElementById('svgLogo').style.display='block'">
        <svg id="svgLogo" width="56" height="56" viewBox="0 0 64 64" style="display:none">
          <defs><linearGradient id="lg2" x1="0" x2="1"><stop offset="0" stop-color="#00f0e0"/><stop offset="1" stop-color="#8b63ff"/></linearGradient></defs>
          <rect x="4" y="4" width="56" height="56" rx="10" fill="url(#lg2)"></rect>
          <text x="50%" y="56%" text-anchor="middle" dominant-baseline="middle" font-weight="900" font-family="Inter,Arial" font-size="26" fill="#041226">B</text>
        </svg>
      </div>
      <div>
        <div class="title">BlockSense — Secure Demo</div>
        <div class="subtitle muted">Blockchain certificate verification — NIT Conclave</div>
      </div>
    </div>
    <div class="controls">
      <div id="networkBadge" class="muted">Disconnected</div>
      <button id="connectBtn" class="btn btn-primary">Connect Wallet</button>
      <button id="exportPdfBtn" class="btn btn-primary">Export PDF</button>
    </div>
  </header>

  <div class="grid">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div><strong>Issue tamper-proof certificate</strong><div class="muted">Store metadata on-chain — generate QR — download PDF</div></div>
        <div style="text-align:right"><div class="muted">Network: <span id="netLabel">—</span></div><div class="muted">Contract: <span id="addrShort">—</span></div></div>
      </div>

      <div style="margin-top:12px" class="form-grid">
        <input id="certId" class="input" placeholder="Certificate ID (eg: BLOCK-001)" />
        <input id="studentName" class="input" placeholder="Recipient full name" />
        <input id="courseName" class="input" placeholder="Course / Event" />
        <input id="rawHash" class="input" placeholder="Optional notes to hash" />
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
        <button id="issueBtn" class="btn btn-primary">Issue Certificate</button>
        <button id="qrBtn" class="btn btn-primary">Generate QR</button>
        <div id="txStatus" class="muted">No transaction yet</div>
      </div>

      <div style="margin-top:14px;display:flex;gap:12px;align-items:flex-start">
        <div class="qr-wrap"><div id="qrcode"></div></div>
        <div style="flex:1">
          <div id="issuedBox" style="display:none" class="panel">
            <div class="muted">Certificate issued on-chain</div>
            <pre id="issuedJson"></pre>
            <div style="margin-top:8px"><button id="downloadIssuedPdf" class="btn">Download issued PDF</button></div>
          </div>
          <div style="margin-top:12px">
            <div><strong>Team</strong></div>
            <div style="display:flex;gap:10px;margin-top:8px">
              <div style="background:linear-gradient(90deg,#6C5CE7,#00E0D7);width:46px;height:46px;border-radius:8px;display:flex;align-items:center;justify-content:center">BJ</div>
              <div><div style="font-weight:800">Bharg Jha</div><div class="muted">Lead Web3 · Frontend/Backend & Contracts</div></div>
              <div style="width:18px"></div>
              <div style="background:linear-gradient(90deg,#FF7A59,#FFBA49);width:46px;height:46px;border-radius:8px;display:flex;align-items:center;justify-content:center">AS</div>
              <div><div style="font-weight:800">Anushaya Singh</div><div class="muted">Documentation & QA</div></div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <div>
      <div class="panel" style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Live session</strong></div>
          <div style="text-align:right"><div id="count" style="font-weight:800">0</div><div class="muted">Certificates</div></div>
        </div>
        <div style="margin-top:12px"><canvas id="chart" height="120"></canvas></div>
      </div>

      <div class="panel">
        <div><strong>Verify certificate</strong><div class="muted">Scan QR or enter Certificate ID</div></div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <input id="verifyId" class="input" placeholder="Enter certId (eg: BLOCK-001)" />
          <button id="verifyBtn" class="btn btn-primary">Verify</button>
        </div>
        <div id="verifyRes" style="display:none;margin-top:12px" class="panel verify-card">
          <div style="flex:1">
            <div id="vStudent" style="font-size:18px;font-weight:800">—</div>
            <div id="vCourse" class="muted">—</div>
            <div id="vMeta" class="muted">Certificate ID: —</div>
          </div>
          <div style="width:160px">
            <div>Status: <span id="vStatus">—</span></div>
            <div class="muted" style="margin-top:8px">Issuer</div>
            <div id="vIssuer">—</div>
            <div class="muted" style="margin-top:8px">Issued</div>
            <div id="vDate">—</div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const contractAddress = "0xC63e1c7D08Ed832D30a8c9E7AAa66C1D898B40c0";
const contractABI = [
	{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"certId","type":"string"},{"indexed":false,"internalType":"string","name":"studentName","type":"string"},{"indexed":false,"internalType":"string","name":"courseName","type":"string"},{"indexed":false,"internalType":"string","name":"certHash","type":"string"},{"indexed":false,"internalType":"uint256","name":"issueDate","type":"uint256"},{"indexed":false,"internalType":"address","name":"issuer","type":"address"}],"name":"CertificateIssued","type":"event"},
	{"inputs":[{"internalType":"string","name":"certId","type":"string"},{"internalType":"string","name":"studentName","type":"string"},{"internalType":"string","name":"courseName","type":"string"},{"internalType":"string","name":"certHash","type":"string"}],"name":"issueCertificate","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"inputs":[{"internalType":"string","name":"certId","type":"string"}],"name":"verifyCertificate","outputs":[{"internalType":"string","name":"studentName","type":"string"},{"internalType":"string","name":"courseName","type":"string"},{"internalType":"string","name":"certHash","type":"string"},{"internalType":"uint256","name":"issueDate","type":"uint256"},{"internalType":"address","name":"issuer","type":"address"}],"stateMutability":"view","type":"function"}
];

const $ = id=>document.getElementById(id);
function toast(msg){const e=document.createElement('div');e.className='toast';e.innerText=msg;document.getElementById('toast').appendChild(e);setTimeout(()=>e.remove(),4200);}

let provider, signer, contract;
let issuedCount=0;
function initChart(){try{const c=$('chart').getContext('2d');window.myChart=new Chart(c,{type:'line',data:{labels:[],datasets:[{label:'issued',data:[],borderColor:'#00f0e0',backgroundColor:'rgba(0,240,224,0.06)',fill:true,tension:0.45}]},options:{plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}})}catch(e){}}

function drawQR(text){const box=$('qrcode');box.innerHTML='';try{new QRCode(box,{text,width:170,height:170,colorDark:"#000000",colorLight:"#ffffff"});}catch(e){box.innerText='QR error'}}

async function connectWallet(){
  try{
    if(!window.ethereum){toast('MetaMask not installed');return;}
    provider=new ethers.providers.Web3Provider(window.ethereum);
    await provider.send('eth_requestAccounts',[]);
    signer=provider.getSigner();
    const addr=await signer.getAddress();
    $('addrShort').innerText=addr.slice(0,6)+'...'+addr.slice(-4);
    const net=await provider.getNetwork();$('netLabel').innerText=net.name||net.chainId;$('networkBadge').innerText='Connected';
    contract=new ethers.Contract(contractAddress,contractABI,signer);
    try{contract.on('CertificateIssued',(certId,studentName,courseName,certHash,issueDate,issuer)=>{addTxDisplay(`Event: ${certId} by ${issuer}`);incrementCount();});}catch(e){}
    toast('Wallet connected');
  }catch(e){console.error(e);toast('Connect failed: '+(e?.message||e));}
}

function addTxDisplay(txt){const node=document.createElement('div');node.style.marginBottom='8px';node.style.color='#cfefff';node.innerText=(typeof txt==='string'?txt:JSON.stringify(txt)).slice(0,400);$('issuedBox').prepend(node)}
function incrementCount(){issuedCount++;$('count').innerText=issuedCount;if(window.myChart){window.myChart.data.labels.push('');window.myChart.data.datasets[0].data.push(Math.floor(Math.random()*6)+1);window.myChart.update();}}

async function issueCertificate(){
  if(!contract){toast('Connect wallet first');return;}
  const certId=$('certId').value.trim(); if(!certId){toast('Enter certificate ID');return;}
  const student=$('studentName').value.trim(); const course=$('courseName').value.trim(); const raw=$('rawHash').value.trim();
  const certHash = raw ? ethers.utils.id(raw) : ethers.utils.hexlify(ethers.utils.randomBytes(12));
  try{
    $('issueBtn').disabled=true; $('txStatus').innerText='Sending transaction...';
    const tx = await contract.issueCertificate(certId, student, course, certHash);
    addTxDisplay(`Tx: ${tx.hash}`); toast('Tx sent: '+tx.hash);
    await tx.wait();
    $('txStatus').innerText='Mined: '+tx.hash;
    const issued = { certId, student, course, certHash, issueDate: new Date().toLocaleString(), issuer: await signer.getAddress() };
    $('issuedJson').innerText = JSON.stringify(issued,null,2);
    $('issuedBox').style.display='block';
    const url = window.location.origin + '/verify.html?certId=' + encodeURIComponent(certId);
    drawQR(url);
    incrementCount();
    // auto-download PDF for issued certificate (detailed)
    await generateIssuedPDF(issued,url);
  }catch(e){console.error(e);toast('Tx failed: '+(e?.message||e));$('txStatus').innerText='Tx failed';}
  finally{$('issueBtn').disabled=false;}
}

async function generateIssuedPDF(obj, verifyUrl){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape', unit:'pt', format:'a4'});
  doc.setFillColor(6,14,32); doc.rect(0,0, doc.internal.pageSize.width, doc.internal.pageSize.height, 'F');
  doc.setDrawColor(139,99,255); doc.setLineWidth(6); doc.rect(18,18, doc.internal.pageSize.width-36, doc.internal.pageSize.height-36, 'S');
  doc.setFontSize(28); doc.setTextColor(255,255,255); doc.text('BlockSense — Certificate',60,80);
  doc.setFontSize(14); doc.setTextColor(200,220,235); doc.text('Tamper-proof on-chain certificate — verify using QR or contract',60,104);
  doc.setFillColor(255,255,255,0.03); doc.rect(60,130,720,220,'F');
  doc.setFontSize(22); doc.setTextColor(255,255,255); doc.text(obj.student||'Recipient Name',80,170);
  doc.setFontSize(12); doc.setTextColor(200,220,235); doc.text('Course: '+(obj.course||'—'),80,200);
  doc.text('Certificate ID: '+(obj.certId||'—'),80,220);
  doc.text('Issued: '+(obj.issueDate||new Date().toLocaleString()),80,240);
  doc.setFontSize(11); doc.setTextColor(200,220,235); doc.text('Verify: '+verifyUrl,80,270);
  const qrCanvas = $('qrcode').querySelector('canvas');
  if(qrCanvas){ const data = qrCanvas.toDataURL('image/png'); doc.addImage(data,'PNG',760,140,120,120); }
  doc.setFontSize(10); doc.setTextColor(190,210,230); doc.text('Issuer: BlockSense • Contract: '+contractAddress,60,doc.internal.pageSize.height-60);
  doc.save((obj.certId||'certificate')+'.pdf');
}

async function verifyCertificate(){
  // requires read-only provider; use ethers defaultProvider via window.ethereum if available fallback to JsonRpcProvider
  const id=$('verifyId').value.trim(); if(!id){toast('Enter cert ID');return;}
  let rprovider;
  try{
    rprovider = new ethers.providers.JsonRpcProvider('https://rpc.sepolia.org');
    const rcontract = new ethers.Contract(contractAddress, contractABI, rprovider);
    const out = await rcontract.verifyCertificate(id);
    const student = out[0]||'';
    const course = out[1]||'';
    const certHash = out[2]||'';
    let issueDate = null;
    if(out[3] && typeof out[3].toNumber === 'function'){ issueDate = out[3].toNumber(); }
    else if(out[3]) issueDate = Number(out[3])||null;
    const issuer = out[4]||'';
    $('vStudent').innerText = student||'—'; $('vCourse').innerText = course||'—'; $('vMeta').innerText = `Certificate ID: ${id}`;
    $('vIssuer').innerText = issuer||'—'; $('vDate').innerText = issueDate ? new Date(issueDate*1000).toLocaleString() : '—'; $('vStatus').innerText = (student||course||issueDate)?'VALID':'NOT FOUND';
    $('verifyRes').style.display='block'; toast('Verify success');
  }catch(e){console.error(e); toast('Verify failed: '+(e?.message||e)); $('vStudent').innerText='—';$('vCourse').innerText='—';$('vMeta').innerText=`Certificate ID: ${id}`;$('vIssuer').innerText='—';$('vDate').innerText='—';$('vStatus').innerText='NOT FOUND';$('verifyRes').style.display='block'}
}

document.addEventListener('DOMContentLoaded',()=>{
  initChart();
  $('connectBtn').addEventListener('click',connectWallet);
  $('issueBtn').addEventListener('click',issueCertificate);
  $('qrBtn').addEventListener('click',()=>{
    const id=$('certId').value.trim(); if(!id){toast('Enter cert ID');return;}
    const url = window.location.origin + '/verify.html?certId=' + encodeURIComponent(id);
    drawQR(url); toast('QR generated');
  });
  $('verifyBtn').addEventListener('click',verifyCertificate);
  $('downloadIssuedPdf').addEventListener('click',()=>{
    const issuedText=$('issuedJson').innerText; if(!issuedText){toast('No issued data');return;}
    const obj = JSON.parse(issuedText); const url = window.location.origin + '/verify.html?certId=' + encodeURIComponent(obj.certId||'');
    generateIssuedPDF(obj,url);
  });
  // initial QR placeholder
  drawQR(window.location.origin + '/verify.html');
  // auto fill verify field if query present
  try{ const u=new URL(location.href); const c=u.searchParams.get('certId'); if(c){$('verifyId').value=c;} }catch(e){}
});
</script>
</body>
</html>

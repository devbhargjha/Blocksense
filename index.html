<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BlockSense — Certificate Verification</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{--bg:#071022;--muted:#9fb3c9;--card:#0b1622;--accent:#06f0d0}
*{box-sizing:border-box}html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#e8fbff}
.container{max-width:980px;margin:36px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center}
.title{font-weight:900}
.panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:18px;border-radius:12px}
.grid{display:flex;gap:18px;align-items:flex-start}
.left{flex:1}
.right{width:260px}
.muted{color:var(--muted)}
.input{padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e8fbff;width:100%}
.btn{padding:10px;border-radius:8px;border:0;background:linear-gradient(90deg,#8b63ff,#00f0e0);color:#041226;cursor:pointer}
.toast{position:fixed;right:18px;bottom:18px;padding:10px 12px;border-radius:8px;background:#061226;color:#dff8ff}
.smallmuted{font-size:13px;color:var(--muted)}
.warn{color:#ffb86b}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="title">BlockSense — Certificate Verification</div>
      <div class="smallmuted">Scan QR or open this page with <code>?certId=ID</code></div>
    </div>
    <div><img src="blocksense-logo.png" alt="logo" style="height:40px;border-radius:6px" onerror="this.style.display='none'"></div>
  </div>

  <div style="margin-top:18px" class="panel">
    <div class="grid">
      <div class="left">
        <div style="display:flex;gap:8px">
          <input id="verifyId" class="input" placeholder="Enter certId or scan QR (eg: BLOCK-001)"/>
          <button id="verifyBtn" class="btn">Verify</button>
        </div>

        <div id="result" style="margin-top:18px">
          <div style="display:flex;gap:12px;align-items:center">
            <div style="flex:1">
              <div class="muted">Recipient</div>
              <div id="vStudent" style="font-weight:800;font-size:18px">—</div>
              <div id="vCourse" class="muted" style="margin-top:6px">—</div>
              <div id="vMeta" class="muted" style="margin-top:8px">Certificate ID: —</div>
            </div>
            <div style="width:220px">
              <div class="muted">Status</div>
              <div id="vStatus" style="font-weight:800;font-size:16px;color:var(--accent)">—</div>
              <div class="muted" style="margin-top:8px">Issuer</div>
              <div id="vIssuer">—</div>
              <div class="muted" style="margin-top:8px">Issued</div>
              <div id="vDate">—</div>
            </div>
          </div>
          <div style="margin-top:14px">
            <button id="downloadVerifyBtn" class="btn">Download verification PDF</button>
          </div>
        </div>

        <div style="margin-top:12px" class="smallmuted">This page reads certificate details from the blockchain (read-only RPC). No wallet required to verify.</div>

        <div id="debug" style="margin-top:12px;color:var(--muted);font-size:13px">
          <div id="dbgLine">RPC: not initialised</div>
          <div id="dbgError" style="color:#ff6b6b"></div>
        </div>

      </div>

      <div class="right">
        <div style="background:var(--card);padding:12px;border-radius:10px;text-align:center">
          <div class="muted">Scan QR or open</div>
          <div id="qrArea" style="margin-top:10px"></div>
          <div id="qrMsg" class="smallmuted" style="margin-top:8px">QR links to this verify page</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const contractAddress = "0xC63e1c7D08Ed832D30a8c9E7AAa66C1D898B40c0";
const contractABI = [
  {"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"certId","type":"string"},{"indexed":false,"internalType":"string","name":"studentName","type":"string"},{"indexed":false,"internalType":"string","name":"courseName","type":"string"},{"indexed":false,"internalType":"string","name":"certHash","type":"string"},{"indexed":false,"internalType":"uint256","name":"issueDate","type":"uint256"},{"indexed":false,"internalType":"address","name":"issuer","type":"address"}],"name":"CertificateIssued","type":"event"},
  {"inputs":[{"internalType":"string","name":"certId","type":"string"}],"name":"verifyCertificate","outputs":[{"internalType":"string","name":"studentName","type":"string"},{"internalType":"string","name":"courseName","type":"string"},{"internalType":"string","name":"certHash","type":"string"},{"internalType":"uint256","name":"issueDate","type":"uint256"},{"internalType":"address","name":"issuer","type":"address"}],"stateMutability":"view","type":"function"}
];

// multiple RPC fallbacks to reduce failure (you can replace/add your Infura/Alchemy URL)
const RPC_FALLBACKS = [
  'https://rpc.sepolia.org',             // public Sepolia
  'https://sepolia.infura.io/v3/YOUR_INFURA_KEY', // replace if you have key
  'https://rpc.ankr.com/eth_sepolia'     // another public provider
];

const $ = id => document.getElementById(id);
function toast(msg){ const e=document.createElement('div'); e.className='toast'; e.innerText=msg; document.getElementById('toast').appendChild(e); setTimeout(()=>e.remove(),4200); }

function drawQR(text){
  const box = $('qrArea'); box.innerHTML = '';
  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
  script.onload = ()=> { try{ new QRCode(box,{text,width:160,height:160}); }catch(e){ box.innerText='QR error'; } };
  document.body.appendChild(script);
}

function fmtDate(ts){
  if(!ts) return '—';
  const n = Number(ts);
  if(isNaN(n) || n === 0) return '—';
  return new Date(n*1000).toLocaleString();
}

let readProvider = null;
let verifyContract = null;
async function initProvider(){
  $('dbgLine').innerText = 'RPC: trying fallbacks...';
  for(const url of RPC_FALLBACKS){
    if(!url) continue;
    try{
      const p = new ethers.providers.JsonRpcProvider(url);
      // do a simple call to test connectivity (chainId)
      const net = await p.getNetwork();
      $('dbgLine').innerText = `RPC OK: ${url} (chain ${net.name||net.chainId})`;
      readProvider = p;
      verifyContract = new ethers.Contract(contractAddress, contractABI, readProvider);
      return;
    }catch(err){
      console.warn('RPC failed', url, err && err.message ? err.message : err);
      $('dbgLine').innerText = `RPC failed: ${url}`;
      // try next
    }
  }
  $('dbgError').innerText = 'All RPC fallbacks failed. Put a working RPC (Infura/Alchemy) in RPC_FALLBACKS.';
  throw new Error('No RPC available');
}

async function verifyFromChain(certId){
  if(!certId) throw new Error('Empty certId');
  if(!verifyContract) await initProvider();
  try{
    const out = await verifyContract.verifyCertificate(certId);
    console.log('verifyCertificate raw out:', out);
    const studentName = out[0]||'';
    const courseName = out[1]||'';
    const certHash = out[2]||'';
    let issueDate = null;
    if(out[3] && typeof out[3].toNumber === 'function'){ issueDate = out[3].toNumber(); }
    else if(out[3]) issueDate = Number(out[3])||null;
    const issuer = out[4]||'';
    const valid = Boolean(studentName || courseName || issueDate);
    $('vStudent').innerText = studentName || '—';
    $('vCourse').innerText = courseName || '—';
    $('vMeta').innerText = `Certificate ID: ${certId||'—'}`;
    $('vIssuer').innerText = issuer || '—';
    $('vDate').innerText = fmtDate(issueDate);
    $('vStatus').innerText = valid ? 'VALID' : 'NOT FOUND';
    return { studentName, courseName, certHash, issueDate, issuer, valid };
  }catch(err){
    console.error('verifyFromChain error', err);
    $('dbgError').innerText = 'Chain call failed: ' + (err && err.message ? err.message : String(err));
    $('vStudent').innerText = '—'; $('vCourse').innerText = '—';
    $('vMeta').innerText = `Certificate ID: ${certId}`; $('vIssuer').innerText = '—'; $('vDate').innerText = '—';
    $('vStatus').innerText = 'NOT FOUND';
    return null;
  }
}

function getParamCertId(){
  try{ const u = new URL(location.href); return u.searchParams.get('certId') || u.searchParams.get('id') || null; }catch(e){ return null; }
}

async function downloadVerificationPDF(data){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape', unit:'pt', format:'a4'});
  doc.setFontSize(20); doc.text('BlockSense — Verification Report',40,60);
  doc.setFontSize(12); doc.text(`Certificate ID: ${data.certId||'—'}`,40,100);
  doc.text(`Recipient: ${data.studentName||'—'}`,40,125);
  doc.text(`Course: ${data.courseName||'—'}`,40,150);
  doc.text(`Issuer: ${data.issuer||'—'}`,40,175);
  doc.text(`Issued On: ${fmtDate(data.issueDate)}`,40,200);
  doc.text(`Cert Hash: ${data.certHash||'—'}`,40,225);
  doc.text(`Verification status: ${data.valid?'VALID':'NOT FOUND'}`,40,255);
  doc.save((data.certId||'verification') + '.pdf');
}

document.addEventListener('DOMContentLoaded', async ()=>{
  drawQR(window.location.origin + '/verify.html');
  // try init quietly
  try{ await initProvider(); }catch(e){ console.warn('initProvider failed', e); }
  $('verifyBtn').addEventListener('click', async ()=>{
    const id = $('verifyId').value.trim();
    if(!id){ toast('Enter cert ID'); return; }
    $('dbgError').innerText = '';
    $('dbgLine').innerText = 'Verifying...';
    const data = await verifyFromChain(id);
    if(data) { $('downloadVerifyBtn').onclick = ()=>downloadVerificationPDF(Object.assign({certId:id}, data)); }
  });
  $('downloadVerifyBtn').addEventListener('click', async ()=>{
    const id = $('verifyId').value.trim(); if(!id){ toast('Enter cert ID'); return; }
    $('dbgError').innerText = '';
    const data = await verifyFromChain(id);
    if(data) downloadVerificationPDF(Object.assign({certId:id}, data));
  });

  const auto = getParamCertId();
  if(auto){
    $('verifyId').value = auto;
    $('dbgLine').innerText = 'Auto verifying from URL...';
    try{ const data = await verifyFromChain(auto); if(data) $('downloadVerifyBtn').onclick = ()=>downloadVerificationPDF(Object.assign({certId:auto}, data)); }catch(e){ console.warn(e); }
  }
});
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BlockSense — Issuer</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{--bg:#03061a;--muted:#9fb3c9;--neon1:#00f0e0;--neon2:#8b63ff}
*{box-sizing:border-box}html,body{height:100%;margin:0;font-family:Inter,system-ui,Roboto,Arial;color:#e8fbff;background:var(--bg)}
.container{max-width:1100px;margin:28px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.logo{display:flex;gap:12px;align-items:center}
.logoBox{width:64px;height:64;border-radius:12px;background:linear-gradient(135deg,var(--neon2),var(--neon1));display:flex;align-items:center;justify-content:center;font-weight:900;color:#041226}
.controls{display:flex;gap:10px;align-items:center}
.btn{padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
.btn-primary{background:linear-gradient(90deg,var(--neon2),var(--neon1));color:#041226}
.panel{background:rgba(255,255,255,0.02);padding:14px;border-radius:12px;margin-top:18px;border:1px solid rgba(255,255,255,0.03)}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.input{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:#e8fbff;outline:none}
.small{font-size:13px;color:var(--muted)}
.cols{display:flex;gap:14px;align-items:flex-start;margin-top:14px}
.qr-box{width:190px;height:190px;border-radius:10px;background:rgba(255,255,255,0.01);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03)}
.muted{color:var(--muted)}
.dev-row{display:flex;gap:10px;margin-top:12px}
.dev-card{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.03)}
#issuedJson{white-space:pre-wrap;color:#dff8ff}
.toast{position:fixed;right:16px;bottom:16px;background:rgba(6,18,34,0.95);padding:10px;border-radius:8px;color:#dff8ff}
@media(max-width:900px){.form-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo">
      <div class="logoBox">B</div>
      <div>
        <div style="font-weight:800">BlockSense — Issuer</div>
        <div class="small muted">Blockchain certificate verification</div>
      </div>
    </div>
    <div class="controls">
      <div id="netLabel" class="small muted">Disconnected</div>
      <button id="connectBtn" class="btn btn-primary">Connect Wallet</button>
      <button id="exportBtn" class="btn">Export PDF</button>
    </div>
  </div>

  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div style="font-weight:900;font-size:18px">Issue tamper-proof certificate</div>
        <div class="small muted">Store metadata on-chain — QR links to public verify page — PDF auto-download after success</div>
      </div>
      <div class="small muted">Contract: <span id="addrShort">—</span></div>
    </div>

    <div class="form-grid" style="margin-top:12px">
      <input id="certId" class="input" placeholder="Certificate ID (e.g. BLOCK-001)" />
      <input id="studentName" class="input" placeholder="Recipient full name" />
      <input id="courseName" class="input" placeholder="Course / Event" />
      <input id="rawHash" class="input" placeholder="Optional notes to hash" />
    </div>

    <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
      <button id="issueBtn" class="btn btn-primary">Issue Certificate</button>
      <button id="qrBtn" class="btn btn-primary">Generate QR</button>
      <div id="txStatus" class="small muted">No transaction yet</div>
    </div>

    <div class="cols">
      <div class="qr-box" id="qrcode"></div>
      <div style="flex:1">
        <div id="issuedBox" style="display:none" class="panel">
          <div class="small muted">Certificate issued on-chain</div>
          <pre id="issuedJson"></pre>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:800">Team</div>
          <div class="dev-row">
            <div class="dev-card"><div style="width:42px;height:42;border-radius:8px;background:linear-gradient(90deg,#6C5CE7,#00E0D7);display:flex;align-items:center;justify-content:center">BJ</div><div><div style="font-weight:800">Bharg Jha</div><div class="small muted">Lead Web3</div></div></div>
            <div class="dev-card"><div style="width:42px;height:42;border-radius:8px;background:linear-gradient(90deg,#FF7A59,#FFBA49);display:flex;align-items:center;justify-content:center">AS</div><div><div style="font-weight:800">Anushaya Singh</div><div class="small muted">Docs & QA</div></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel" style="margin-top:16px">
    <div style="font-weight:900">Live session</div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
      <div class="small muted">Real-time issued count</div>
      <div id="count" style="font-weight:800">0</div>
    </div>
  </div>

</div>

<div id="toastArea"></div>

<script>
const contractAddress = "0xC63e1c7D08Ed832D30a8c9E7AAa66C1D898B40c0";
const contractABI = [
	{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"certId","type":"string"},{"indexed":false,"internalType":"string","name":"studentName","type":"string"},{"indexed":false,"internalType":"string","name":"courseName","type":"string"},{"indexed":false,"internalType":"string","name":"certHash","type":"string"},{"indexed":false,"internalType":"uint256","name":"issueDate","type":"uint256"},{"indexed":false,"internalType":"address","name":"issuer","type":"address"}],"name":"CertificateIssued","type":"event"},
	{"inputs":[{"internalType":"string","name":"certId","type":"string"},{"internalType":"string","name":"studentName","type":"string"},{"internalType":"string","name":"courseName","type":"string"},{"internalType":"string","name":"certHash","type":"string"}],"name":"issueCertificate","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"inputs":[{"internalType":"string","name":"certId","type":"string"}],"name":"verifyCertificate","outputs":[{"internalType":"string","name":"studentName","type":"string"},{"internalType":"string","name":"courseName","type":"string"},{"internalType":"string","name":"certHash","type":"string"},{"internalType":"uint256","name":"issueDate","type":"uint256"},{"internalType":"address","name":"issuer","type":"address"}],"stateMutability":"view","type":"function"}
];

const $ = id => document.getElementById(id);
function toast(t){
  const el = document.createElement('div');
  el.className='toast';
  el.innerText = t;
  $('toastArea').appendChild(el);
  setTimeout(()=> el.remove(),3800);
}

let provider, signer, contract;
let issuedCount = 0;

async function connectWallet(){
  try{
    if(!window.ethereum){ toast('MetaMask not found'); return; }
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send('eth_requestAccounts', []);
    signer = provider.getSigner();
    const addr = await signer.getAddress();
    $('addrShort').innerText = addr.slice(0,6)+'...'+addr.slice(-4);
    const net = await provider.getNetwork();
    $('netLabel').innerText = net.name || net.chainId;
    contract = new ethers.Contract(contractAddress, contractABI, signer);
    toast('Wallet connected');
    try{
      contract.on('CertificateIssued', (certId, studentName, courseName, certHash, issueDate, issuer) => {
        addIssuedDisplay(certId + ' by ' + issuer);
        incrementCount();
      });
    }catch(e){}
  }catch(e){ console.error(e); toast('Connect failed'); }
}

function drawQR(text){
  const box = $('qrcode');
  box.innerHTML = '';
  new QRCode(box, { text, width:170, height:170, colorDark:"#000000", colorLight:"#ffffff" });
}

function addIssuedDisplay(txt){
  const box = $('issuedBox');
  const node = document.createElement('div');
  node.innerText = txt;
  node.style.marginBottom='8px';
  box.prepend(node);
  box.style.display='block';
}

function incrementCount(){ issuedCount++; $('count').innerText = issuedCount; }

async function issueCertificate(){
  if(!window.ethereum){ toast('Connect wallet first'); return; }
  if(!contract) await connectWallet();
  const certId = $('certId').value.trim(); if(!certId){ toast('Enter cert ID'); return; }
  const student = $('studentName').value.trim(); const course = $('courseName').value.trim();
  const raw = $('rawHash').value.trim();
  const certHash = raw ? ethers.utils.id(raw) : ethers.utils.hexlify(ethers.utils.randomBytes(12));
  try{
    $('issueBtn').disabled=true; $('txStatus').innerText='Sending tx...';
    const tx = await contract.issueCertificate(certId, student, course, certHash);
    toast('Tx sent: '+tx.hash);
    addIssuedDisplay('Tx: '+tx.hash);
    await tx.wait();
    $('txStatus').innerText='Mined: '+tx.hash;
    const issued = { certId, student, course, certHash, issueDate: new Date().toLocaleString(), issuer: await signer.getAddress() };
    $('issuedJson').innerText = JSON.stringify(issued, null, 2);
    // generate QR that points to verify.html
    const verifyUrl = window.location.origin + (window.location.pathname.endsWith('/') ? '' : '/') + 'verify.html?certId=' + encodeURIComponent(certId);
    drawQR(verifyUrl);
    incrementCount();
    toast('Certificate issued — PDF generating');
    generatePDF(issued, verifyUrl, true);
  }catch(e){ console.error(e); toast('Tx failed'); $('txStatus').innerText='Tx failed'; }
  finally{ $('issueBtn').disabled=false; }
}

function generatePDF(obj, verifyUrl, autoDownload=false){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape', unit:'pt', format:'a4'});
  doc.setFillColor(6,14,32); doc.rect(0,0,doc.internal.pageSize.width, doc.internal.pageSize.height,'F');
  doc.setTextColor(255,255,255); doc.setFontSize(22); doc.text('BlockSense — Certificate', 60,70);
  doc.setFontSize(14); doc.setTextColor(200,220,235); doc.text('Tamper-proof certificate — Verify using QR or ID', 60,96);
  doc.setFillColor(255,255,255,0.03); doc.rect(60,140,680,200,'F');
  doc.setFontSize(20); doc.setTextColor(255,255,255); doc.text(obj.student || 'Recipient', 80,180);
  doc.setFontSize(12); doc.setTextColor(200,220,235); doc.text('Course / Event: ' + (obj.course||'—'),80,205);
  doc.text('Certificate ID: ' + (obj.certId||'—'),80,225);
  doc.text('Issue Date: ' + (obj.issueDate||'—'),80,245);
  doc.text('Cert Hash: ' + (obj.certHash||'—'),80,265);
  // draw small verify URL text
  doc.setFontSize(10); doc.setTextColor(180,200,220); doc.text('Verify: ' + verifyUrl, 80, 292);
  // embed QR if possible by creating a temporary canvas
  const qrCanvas = document.createElement('div');
  try{
    new QRCode(qrCanvas, { text: verifyUrl, width:160, height:160, colorDark:"#000000", colorLight:"#ffffff" });
    setTimeout(()=>{
      const c = qrCanvas.querySelector('canvas');
      if(c){
        const data = c.toDataURL('image/png');
        doc.addImage(data,'PNG',760,150,120,120);
        if(autoDownload) doc.save((obj.certId||'certificate') + '.pdf');
      } else {
        if(autoDownload) doc.save((obj.certId||'certificate') + '.pdf');
      }
    },120);
  }catch(e){
    if(autoDownload) doc.save((obj.certId||'certificate') + '.pdf');
  }
}

async function manualExport(){
  const issuedText = $('issuedJson').innerText;
  const obj = issuedText ? JSON.parse(issuedText) : { certId:$('certId').value||'N/A', student:$('studentName').value||'N/A', course:$('courseName').value||'N/A', issueDate:new Date().toLocaleString(), certHash:'—' };
  const url = `https://devbhargjha.github.io/Blocksense/verify.html?certId=${encodeURIComponent(certId)}`;
  generatePDF(obj, url, true);
}

document.addEventListener('DOMContentLoaded', ()=>{
  $('connectBtn').addEventListener('click', connectWallet);
  $('issueBtn').addEventListener('click', issueCertificate);
  $('qrBtn').addEventListener('click', ()=>{
    const id = $('certId').value.trim();
    if(!id){ toast('Enter cert ID'); return; }
    const verifyUrl = `https://devbhargjha.github.io/Blocksense/verify.html?certId=${encodeURIComponent(id)}`;
    toast('QR generated');
  });
  $('exportBtn').addEventListener('click', manualExport);
  // placeholder QR points to verify.html root
  drawQR(window.location.origin + (window.location.pathname.endsWith('/') ? '' : '/') + 'verify.html');
});
</script>
</body>
</html>

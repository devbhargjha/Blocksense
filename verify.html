<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BlockSense — Verify</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{--bg:#031027;--card:#071228;--muted:#9fb3c9;--accent1:#00f0e0;--accent2:#8b63ff}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Roboto,Arial;color:#e8fbff;background:linear-gradient(180deg,#021022,#041227)}
.container{max-width:900px;margin:36px auto;padding:20px}
.header{display:flex;align-items:center;gap:14px}
.logo{width:64px;height:64;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent1));display:flex;align-items:center;justify-content:center;font-weight:900;color:#041226}
.title{font-weight:900;font-size:20px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:18px;border-radius:12px;margin-top:18px}
.input{width:100%;padding:12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:#dff8ff}
.btn{padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent2),var(--accent1));color:#041226;font-weight:800;border:0;cursor:pointer}
.muted{color:var(--muted)}
.result{display:flex;justify-content:space-between;align-items:center;gap:12px}
.result-left{flex:1}
.result-right{text-align:right;width:180px}
.kv{color:#cfefff;font-weight:700}
.small{font-size:13px;color:var(--muted)}
.qrBox{width:160px;height:160px;border-radius:10px;background:#fff;padding:6px;display:flex;align-items:center;justify-content:center}
.footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo">B</div>
    <div>
      <div class="title">BlockSense — Certificate Verify</div>
      <div class="small">Scan QR or enter Certificate ID to validate (no wallet needed)</div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;gap:10px;align-items:center">
      <input id="certInput" class="input" placeholder="Enter Certificate ID (eg: BLOCK-001)" />
      <button id="checkBtn" class="btn">Check</button>
      <button id="downloadPdfBtn" class="btn" style="background:linear-gradient(90deg,#06f0d0,#7c5cff)">Download PDF</button>
    </div>

    <div style="display:flex;gap:16px;margin-top:16px;align-items:flex-start">
      <div style="flex:1">
        <div id="statusCard" class="card" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div>
              <div id="nameField" style="font-weight:900;font-size:20px">—</div>
              <div id="courseField" class="small" style="margin-top:6px">—</div>
              <div id="idField" class="small" style="margin-top:10px;color:#cfefff">Certificate ID: —</div>
              <div style="margin-top:10px" class="small">Hash: <span id="hashField" class="kv">—</span></div>
            </div>
            <div class="result-right">
              <div style="font-weight:900;color:#06f0d0">Status</div>
              <div id="statusField" style="font-weight:900;font-size:18px;margin-top:6px">—</div>
              <div class="small" style="margin-top:12px">Issuer</div>
              <div id="issuerField" style="font-weight:700">—</div>
              <div class="small" style="margin-top:8px">Issued</div>
              <div id="dateField">—</div>
            </div>
          </div>
        </div>

        <div id="notFoundCard" class="card" style="display:none">
          <div style="font-weight:900;color:#ff7a7a">Certificate not found</div>
          <div class="small" style="margin-top:8px">Either ID is wrong or certificate not issued on-chain yet.</div>
        </div>
      </div>

      <div style="width:180px">
        <div style="font-weight:800;margin-bottom:8px">QR (opens this verify page)</div>
        <div class="qrBox" id="qrHolder"></div>
        <div class="small" style="margin-top:10px;color:var(--muted)">Scan with any camera — opens this page showing authenticity.</div>
      </div>
    </div>

    <div class="footer">Hosted verify page must be public (HTTPS) so phone scanners can open it directly.</div>
  </div>
</div>

<script>
const RPC_URL = "https://sepolia.infura.io/v3/YOUR_INFURA_KEY";
const contractAddress = "0xc7BD099627d1C65170a34a3215aB2FC1937d419C";
const contractABI = [{"inputs":[{"internalType":"string","name":"certId","type":"string"}],"name":"verifyCertificate","outputs":[{"internalType":"string","name":"studentName","type":"string"},{"internalType":"string","name":"courseName","type":"string"},{"internalType":"string","name":"certHash","type":"string"},{"internalType":"uint256","name":"issueDate","type":"uint256"},{"internalType":"address","name":"issuer","type":"address"}],"stateMutability":"view","type":"function"}];

const $ = id => document.getElementById(id);
function drawQR(text){ const box = $('qrHolder'); box.innerHTML=''; new QRCode(box,{text,width:140,height:140}); }
function toast(msg){ alert(msg); }

let provider, contract;
async function initProvider(){
  try{
    provider = new ethers.providers.JsonRpcProvider(RPC_URL);
    contract = new ethers.Contract(contractAddress, contractABI, provider);
  }catch(e){ console.error(e); toast('Provider init failed — set RPC_URL'); }
}
async function doVerify(certId){
  $('statusCard').style.display='none';
  $('notFoundCard').style.display='none';
  try{
    const out = await contract.verifyCertificate(certId);
    const student = out[0] || '—';
    const course = out[1] || '—';
    const certHash = out[2] || '—';
    let issueDate = '—';
    try{ if(out[3] && out[3].toNumber) issueDate = new Date(out[3].toNumber()*1000).toLocaleString(); else issueDate = out[3]; }catch(err){}
    const issuer = out[4] || '—';
    $('nameField').innerText = student;
    $('courseField').innerText = course;
    $('idField').innerText = 'Certificate ID: ' + certId;
    $('hashField').innerText = certHash;
    $('issuerField').innerText = issuer;
    $('dateField').innerText = issueDate;
    $('statusField').innerText = 'VALID';
    $('statusField').style.color = '#06f0d0';
    $('statusCard').style.display = 'block';
    drawQR(window.location.origin + window.location.pathname + '?certId=' + encodeURIComponent(certId));
  }catch(e){
    console.error(e);
    $('notFoundCard').style.display='block';
    drawQR(window.location.origin + window.location.pathname + '?certId=' + encodeURIComponent(certId));
  }
}

function downloadPDF(){
  const name = $('nameField').innerText || 'Recipient';
  const course = $('courseField').innerText || 'Course';
  const id = ($('idField').innerText || '').replace('Certificate ID: ','') || '—';
  const hash = $('hashField').innerText || '—';
  const issuer = $('issuerField').innerText || '—';
  const issued = $('dateField').innerText || new Date().toLocaleString();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape', unit:'pt', format:'a4'});
  doc.setFillColor(6,14,32); doc.rect(0,0, doc.internal.pageSize.width, doc.internal.pageSize.height, 'F');
  doc.setDrawColor(140,99,255); doc.setLineWidth(6); doc.rect(18,18, doc.internal.pageSize.width-36, doc.internal.pageSize.height-36, 'S');
  doc.setFontSize(26); doc.setTextColor(255,255,255); doc.text('BlockSense — Certificate', 60, 80);
  doc.setFontSize(18); doc.setTextColor(220,240,255); doc.text(name, 80, 150);
  doc.setFontSize(12); doc.setTextColor(200,220,235);
  doc.text('Course: ' + course, 80, 180);
  doc.text('Certificate ID: ' + id, 80, 200);
  doc.text('Hash: ' + hash, 80, 220);
  doc.text('Issuer: ' + issuer, 80, 240);
  doc.text('Issued: ' + issued, 80, 260);
  const qrCanvas = document.createElement('canvas'); try{
    const qrText = window.location.origin + window.location.pathname + '?certId=' + encodeURIComponent(id);
    new QRCode(qrCanvas, { text: qrText, width:140, height:140 });
  }catch(e){}
  try{
    const canvas = $('qrHolder').querySelector('canvas');
    if(canvas) doc.addImage(canvas.toDataURL('image/png'),'PNG',520,120,140,140);
  }catch(e){}
  doc.save((id || 'certificate') + '.pdf');
}

window.addEventListener('load', async ()=>{
  await initProvider();
  const params = new URLSearchParams(location.search);
  const c = params.get('certId');
  if(c){ $('certInput').value = c; doVerify(c); } else drawQR(window.location.origin + window.location.pathname);
  $('checkBtn').addEventListener('click', ()=>{ const id = $('certInput').value.trim(); if(!id) return alert('Enter cert id'); doVerify(id); });
  $('downloadPdfBtn').addEventListener('click', downloadPDF);
});
</script>
</body>
</html>

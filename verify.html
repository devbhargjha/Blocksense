<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BlockSense — Verify</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
body{margin:0;font-family:Inter,Arial;background:#0b1120;color:#e8fbff;display:flex;align-items:center;justify-content:center;height:100vh}
.card{width:920px;padding:28px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));box-shadow:0 20px 80px rgba(2,6,12,0.7)}
.header{display:flex;justify-content:space-between;align-items:center}
.h1{font-size:22px;font-weight:900}
.muted{color:#9fb3c9}
.grid{display:grid;grid-template-columns:1fr 320px;gap:20px;margin-top:18px}
.left{padding:12px}
.right{padding:12px;border-left:1px solid rgba(255,255,255,0.03)}
.kv{margin-top:10px}
.k{color:#9fb3c9;font-size:13px}
.v{font-weight:800;margin-top:4px}
.valid{color:#39ffb0;font-weight:900}
.invalid{color:#ff6b6b;font-weight:900}
.qr{display:flex;align-items:center;justify-content:center;background:#fff;padding:10px;border-radius:8px}
.note{margin-top:12px;color:#9fb3c9;font-size:13px}
</style>
</head>
<body>
<div class="card">
  <div class="header">
    <div>
      <div class="h1">BlockSense — Certificate Verification</div>
      <div class="muted">Scan QR or open this page with ?certId=ID</div>
    </div>
    <div id="status" class="muted">—</div>
  </div>

  <div class="grid">
    <div class="left">
      <div class="kv"><div class="k">Recipient</div><div id="student" class="v">—</div></div>
      <div class="kv"><div class="k">Course</div><div id="course" class="v">—</div></div>
      <div class="kv"><div class="k">Certificate ID</div><div id="cid" class="v">—</div></div>
      <div class="kv"><div class="k">Cert Hash</div><div id="chash" class="v">—</div></div>
      <div class="kv"><div class="k">Issuer</div><div id="issuer" class="v">—</div></div>
      <div class="kv"><div class="k">Issued On</div><div id="issued" class="v">—</div></div>

      <div style="margin-top:18px">
        <button id="downloadBtn" style="padding:10px 14px;border-radius:8px;background:linear-gradient(90deg,#8b63ff,#00f0e0);border:0;color:#041226;font-weight:800">Download verification PDF</button>
      </div>

      <div class="note">This page reads the certificate details from the blockchain (read-only RPC). No wallet needed to verify.</div>
    </div>

    <div class="right">
      <div id="verStatus" style="text-align:center;font-weight:900;font-size:18px;color:#fff">Status: <span id="st" class="invalid">—</span></div>
      <div style="margin-top:12px;text-align:center" id="qrbox"><div class="qr" id="qrcode">QR</div></div>
    </div>
  </div>
</div>

<script>
const PUBLIC_URL = 'https://devbhargjha.github.io/Blocksense';
const contractAddress = "0xC63e1c7D08Ed832D30a8c9E7AAa66C1D898B40c0";
const contractABI = [{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"certId","type":"string"},{"indexed":false,"internalType":"string","name":"studentName","type":"string"},{"indexed":false,"internalType":"string","name":"courseName","type":"string"},{"indexed":false,"internalType":"string","name":"certHash","type":"string"},{"indexed":false,"internalType":"uint256","name":"issueDate","type":"uint256"},{"indexed":false,"internalType":"address","name":"issuer","type":"address"}],"name":"CertificateIssued","type":"event"},{"inputs":[{"internalType":"string","name":"certId","type":"string"},{"internalType":"string","name":"studentName","type":"string"},{"internalType":"string","name":"courseName","type":"string"},{"internalType":"string","name":"certHash","type":"string"}],"name":"issueCertificate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"certId","type":"string"}],"name":"verifyCertificate","outputs":[{"internalType":"string","name":"studentName","type":"string"},{"internalType":"string","name":"courseName","type":"string"},{"internalType":"string","name":"certHash","type":"string"},{"internalType":"uint256","name":"issueDate","type":"uint256"},{"internalType":"address","name":"issuer","type":"address"}],"stateMutability":"view","type":"function"}];

function $id(id){return document.getElementById(id);}
function drawQR(text){
  $id('qrcode').innerHTML = '';
  const s = document.createElement('div'); s.style.width='180px'; s.style.height='180px';
  new QRious && null;
  try{
    // small inline QR lib (canvas)
    const canvas = document.createElement('canvas'); canvas.width=180; canvas.height=180;
    // simple QR using external lib not available here, create fallback link
    $id('qrcode').innerText = '';
    const a = document.createElement('a'); a.href = text; a.innerText = 'Open verification link'; a.target='_blank';
    $id('qrcode').appendChild(a);
  }catch(e){
    $id('qrcode').innerText = text;
  }
}

function getParam(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}

async function verifyFromParam(){
  const id = getParam('certId');
  if(!id){ $id('st').innerText='NO ID'; $id('st').className='invalid'; return; }
  $id('cid').innerText = id;
  try{
    const provider = new ethers.providers.JsonRpcProvider('https://rpc.sepolia.org');
    const readContract = new ethers.Contract(contractAddress, contractABI, provider);
    const out = await readContract.verifyCertificate(id);
    const studentName = out[0] || '—';
    const courseName = out[1] || '—';
    const certHash = out[2] || '—';
    const issueDate = (out[3] && out[3].toNumber) ? new Date(out[3].toNumber()*1000).toLocaleString() : (out[3] || '—');
    const issuer = out[4] || '—';
    $id('student').innerText = studentName;
    $id('course').innerText = courseName;
    $id('chash').innerText = certHash;
    $id('issuer').innerText = issuer;
    $id('issued').innerText = issueDate;
    $id('st').innerText = 'VALID'; $id('st').className='valid';
    drawQR(location.href);
  }catch(e){
    console.error(e);
    $id('st').innerText = 'NOT FOUND'; $id('st').className='invalid';
    $id('student').innerText='—'; $id('course').innerText='—'; $id('chash').innerText='—'; $id('issuer').innerText='—'; $id('issued').innerText='—';
  }
}

window.addEventListener('load', ()=>{
  verifyFromParam();
  $id('downloadBtn').addEventListener('click', async ()=>{
    // create a small verification PDF using jsPDF CDN if needed
    const win = window.open(location.href, '_blank');
    setTimeout(()=>{ win.focus(); },500);
  });
});
</script>
</body>
</html>
